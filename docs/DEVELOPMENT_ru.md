# Текущее состояние проекта
## Changelog

1.x.x - предрелизная ветка

Так как все доработки не ломают совместимости, планируется ветки, по мере разработки сливать с `master` и делать соответствующий tag.

## Процесс разработки

На доску в "Projects: Issues DAM list" набираются таски.
На каждую таску создается merge request. Все мерджи сливаются в ветку `1.x.x`. 
После того, как набор тасок закончился, код слит и протестирован в `1.x.x`.
Делается коммит в `1.x.x` ветке, где в файле `config/sys.config.go` правится релизная версия утилиты.
Код мерджится в master и создается релиз с тегом и описанием.
Документация не привязана к версиям и также обновляется в `1.x.x`. Для нее выделена доска "Projects: Documentation"

## Особенности
- Если случается ошибка при которой работа программы не возможна, вызывается исключение.
Это не клиент-серверное приложение, а обычная утилита, где код выполняется последовательно. 
Поэтому, если работа приложения прерывается, 
то в подфункциях нет смысла передавать ошибку на верх и исключение c выходом из программы происходит сразу.
Преимущество в том:
 - что нет смысла 'загрязнять' код передачей в main ошибок;
 - проблема в коде находится быстрее;
 - ошибки учат пользователя правильно работать с утилитой.

## При работе с репозиториями
При первом запуске dam видит, что нет в базе записи о репозиториях, создает новую
```
1|*|official|registry.docker.local||
```
Здесь формат `Id|Default|RepoName|RepoServer|Login|Password`.
Эту запись нельзя удалить стандартными средствами dam.

База для хранения репозиториев внутренняя, написана чтобы не было у утилиты внешних зависимостей от дистрибутива. 
Возможно в будущем добавится поддержка Sqlite3, т.к. эта DB идет с большинством дистрибутивов по умолчанию.

### Примечания к репозиториям
- Флаг --default:
  Если добавляется первый репозиторий (автоматически), то он всегда дефолтный. Пишется предупреждение, если флаг дефолта не задается.
  Если добавляется новый репозиторий и указывается дефолтный, то метка со старого снимается.
  Без опции --skip нельзя удалить дефолтный репозиторий.
  При удалении дефолтного репозитория, дефолтным назначается первый.
  Первый репозиторий с id = 0 не удалить, не изменить.  
  По умолчанию, без флага --default, добавляется не дефолтный репозиторий.
  Если дефолтный репозиторий меняется на недефолтный, то дефолтным становится первый репозиторий.
  Если флаг --default не указан при изменении репозитория, то значение Default в базе не меняется.
  Если есть дефолтный репозиторий и новый изменяется на дефолтный, то метка со старого убирается.
  
- Флаг --name:
  При добавлении репозитория, если имя есть в базе, то ошибка.
  Если при добавлении имя - номер (имеет формат, как id), то ошибка.
  Имя репозитория содержит только (3 - 9) буквы и цифры с учетом регистра.
  При изменении на новое имя те же проверки, что и на добавление.
  Если флаг не задан при изменении репозитория, имя не меняется.
  Репозиторий может удаляться, по имени.
  
- Флаг --server:
  Для официального registry - это имя сервера, для локального не только имя, но и префикс приложения до знака "/"
  Это любая не пустая строка до 120 символов.
  
- Флаг --login:
  Любая строка < 24 символов.
  
- Флаг --password:
  Не отображается в выводе.
  Хранится в зашифрованном виде (!) в base64 =).
  
- Id:
  Каждая строка в текстовой базе в начале имеет ID.
  Строки отсортированы по ID в порядке возрастания.
  При удалении репозитория удаляется вся строка с ID и данный номер перестает существовать.
  При добавлении репозитория новый Id берется большим, чем каждый из текущих Id в базе.
  Id с номером 0 - официальный репозиторий.
  
- Флаг --raw:
Выводит информацию об репозиториях

## Термины
- repos - репозиторий приложений DAM ( ~ соответствует префиксу тэга docker до символа "/")
- app - приложение DAM, специальным образом подготовленный docker image для работы с dam

## Пример files_db

Файл Repos:

`1|*|official|registry.docker.local||
2||local|localhost:5000||
`

Файл Apps:

`1|fd78216a9d61|go-installer|2.4.7_18|2||go-installer
2|sd78216a9d61|mongodb|3.4.2_1|1||mongodb
3|1d78216a9d61|influxdb|last|1||influxdb-local
`


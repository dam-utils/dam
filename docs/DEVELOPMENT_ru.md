# Текущее состояние проекта
## Changelog

1.x.x - добавляются команды:
- проверить правильность флагов
- функциональные тесты с моками

Так как все доработки не ломают совместимости, планируется ветки, по мере разработки сливать с master и делать соответствующий tag.

## Договоренности
- Если случается ошибка при которой работа программы не возможна, вызывается исключение.
Это не клиент-серверное приложение, а обычная утилита, где код выполняется последовательно. 
Поэтому, если работа приложения прерывается, то в подфункциях нет смысла передавать ошибку на верх и исключение происходит сразу.
Преимущество в том:
 - что нет смысла загрязнять код ошибками;
 - проблема в коде находится быстрее;
 - ошибки учат пользователя правильно работать с утилитой.

## Критичные баги и доработки

- посмотреть description флагов, возможно у purge и create напутал с описанием и обязательностью флага (а вообще лучше все глянуть)
- не должно бы выкачивать зависимости go mod если существует кэш с vendor
- работать лучше с абсолютными путями к файлам
- запрашивать или выдавать предупреждение при установке, что контрольной суммы нет в имени
- с каким тэгом загружать образ??? с репозиторием?
- проверять при распаковке (создании файлов), может они уже существуют
- подсветка текста в поиске и при установке
- dam remove удаляет по имени, а надо по имени и версии (multiversion) или id
- часто возникают ошибки - не возможно подключиться к репозиторию. Стоит добавить полезную информацию, почему
- добавить таймауты на http запросы, Content-Length и обработку кодов возврата
- когда парсим строку в files_db - смотреть длину полей. Она должна совпадать с числом полей в app или repo
- добавить флаг с выводом дебага
- исправить dam --help
- добавить флаг rm --force (удаляет из базы, даже если есть ошибки)
removeAppCmd.Flags().BoolVar(&run.RemoveAppFlags.Force, "force", false, "Removing applications from the database with ignoring errors.")
- баг при search eee (пустые репозитории выводятся без переносов)
- настройка в конфиге при search - показывать первые n версий
- при внутренней валидации files_db не показывать пароли в ошибках
- при плохом закрытии файла или соединения не падать, а писать ошибку
- проверка GetApps() и GetRepos() на nil

## Нерешенные вопросы, доработки по текущим версиям, низкого приоритета

- добавить //	listCmd.Flags().StringVar(&run.ListFlags.Labels, "labels", "", "List all installed applications with labels.")
- ввести возможность неявного указания репозитория из существующих в базе вида "dam install repo-name/test:1.0"
- перевести временные дирректории на ioutil.TempDir
- Скрывать ворнинг "WARN: Cannot pull docker image with error:"
- после logger.Fatal добавить return, чтобы линтер не подчеркивал
- возможно стоит переделать сортировку версий приложений для semantic version (плохо отрабатывает на не числовых версиях)
- сделать init тесты для dam search сделав mock для docker api
- продумать поддержку для более широкого числа версий docker api
(возможно стоит делать запрос к server docker, брать версию и сравнивать со своим диапазоном)
- запретить параллельную работу с базой, добавить блокировки (по сути на одной системе, работа команды dam должна быть атомарна)
(возможно стоит проверять, есть ли dam в процессах)
- вспомнить возможности оригинальной утилиты
- как хранить login и password. Сейчас логика: 
Если утилита работает с docker под обычным пользователем, она может вычитать секреты из любого места. 
Т.е. имеет смысл защищать секреты от обычных пользователей вне группы docker.
Для этого файлам files_db стоит дать права 600. Вынести настойку прав в конфиг.
(Думаю сейчас нет смысла защищать эти файлы, если пользователь имеет доступ к docker. 
Получается достаточно добавить доступ к этим файлам для тех, кто в группе docker)
- некоторые настройки конфига стоит вынести в переменные окружения (разобраться с viper или сделать dam settings)
- рассмотреть работу dam на Windows (Проблема: файлы install общие для архитектур)
- пересмотреть тесты на работу с репозиториями (логика работы с дефолтными репозиториями часто менялась, а тесты на регрессию не добавлялись)
- добавить проверки, в строках DB не должны содержаться символы raw separator и db separator и флаги подкоманд
- добавить log file в котором писались бы установленные/удаленные приложения (ошибки).
- dam search возможно, стоит добавить рутины на несколько http запросов (ускорит медленный поиск в официальном репозитории)
- добавить описание проекта на английском
- разобраться с созданием файла и маской
- перед копированием файла проверять, что не существует ли уже файл
- следует создать флаг для указания docker build opts
- добавить info информацию в вывод docker
- поправить права у файла-базы Apps
- переделать конкатенацию строк на strings.Builder

## При работе с репозиториями
При первом запуске dam видит, что нет в базе записи о репозиториях, создает новую
```
1|*|official|registry.docker.local||
```
Здесь формат `Id|Default|RepoName|RepoServer|Login|Password`.
Эту запись нельзя удалить стандартными средствами dam.

База для хранения репозиториев внутренняя, написана чтобы не было у утилиты внешних зависимостей от дистрибутива. 
Возможно в будущем добавится поддержка Sqlite3, т.к. эта DB идет с большинством дистрибутивов по умолчанию.

### Примечания к репозиториям
- Флаг --default:
  Если добавляется первый репозиторий (автоматически), то он всегда дефолтный. Пишется предупреждение, если флаг дефолта не задается.
  Если добавляется новый репозиторий и указывается дефолтный, то метка со старого снимается.
  Без опции --skip нельзя удалить дефолтный репозиторий.
  При удалении дефолтного репозитория, дефолтным назначается первый.
  Первый репозиторий с id = 0 не удалить, не изменить.  
  По умолчанию, без флага --default, добавляется не дефолтный репозиторий.
  Если дефолтный репозиторий меняется на недефолтный, то дефолтным становится первый репозиторий.
  Если флаг --default не указан при изменении репозитория, то значение Default в базе не меняется.
  Если есть дефолтный репозиторий и новый изменяется на дефолтный, то метка со старого убирается.
  
- Флаг --name:
  При добавлении репозитория, если имя есть в базе, то ошибка.
  Если при добавлении имя - номер (имеет формат, как id), то ошибка.
  Имя репозитория содержит только (3 - 9) буквы и цифры с учетом регистра.
  При изменении на новое имя те же проверки, что и на добавление.
  Если флаг не задан при изменении репозитория, имя не меняется.
  Репозиторий может удаляться, по имени.
  
- Флаг --server:
  Для официального registry - это имя сервера, для локального не только имя, но и префикс приложения до знака "/"
  Это любая не пустая строка до 120 символов.
  
- Флаг --login:
  Любая строка < 24 символов.
  
- Флаг --password:
  Не отображается в выводе.
  Хранится в зашифрованном виде (!) в base64 =).
  
- Id:
  Каждая строка в текстовой базе в начале имеет ID.
  Строки отсортированы по ID в порядке возрастания.
  При удалении репозитория удаляется вся строка с ID и данный номер перестает существовать.
  При добавлении репозитория новый Id берется большим, чем каждый из текущих Id в базе.
  Id с номером 0 - официальный репозиторий.
  
- Флаг --raw:
Выводит информацию об репозиториях

## Термины
- repos - репозиторий приложений DAM ( ~ соответствует префиксу тэга docker до символа "/")
- app - приложение DAM, специальным образом подготовленный docker image для работы с dam

## Пример files_db

Файл Repos:

`1|*|official|registry.docker.local||
2||local|localhost:5000||
`

Файл Apps:

`1|fd78216a9d61|go-installer|2.4.7_18|2||go-installer
2|sd78216a9d61|mongodb|3.4.2_1|1||mongodb
3|1d78216a9d61|influxdb|last|1||influxdb-local
`


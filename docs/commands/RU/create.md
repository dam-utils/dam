# dam create
Команда создает приложение. 
Для команды предусмотрены флаги:
* --name - для указания имени приложения
* --version - для указания версии
* --family - указывает, какой группе принадлежит приложение. По умолчанию, не возможно установить два приложения с одинаковой группой.
Если флаг не задан, то его значение берется равным флагу --name
* --multivesrion - дает разрешение приложению устанавливаться в системе, даже если его группа присутствует у уже установленных приложений

Для работы команды необходимо в директории с проектом разместить Dockerfile
 и каталог `meta`, имеющий следующую структуру: 
```
meta/
    DESCRIPTION (не обязателен)
    install.exp (не обязателен)
    install
    uninstall.exp (не обязателен)
    uninstall
    ENVIRONMENT (не обязателен)
```

Где в файлах .exp будут заменены переменные окружения и они превратятся в файлы без .exp при создании.
В install может быть сформировано имя образа, чтобы во внешней системе знать, что устанавливать.
Заменяются все переменные в скобках ${} на переменные взятые из:
- файла ENVIRONMENT
- Dockerfile
- переменных окружения, начинающихся с префикса `DAM`. Например, DAM_PWD="./dam"
Для тех переменных, что найдены в файле при замене, но пустые, выводятся при сборке ворнинги.

Чтобы переменные окружения не заменялись, можно не указывать фигурные скобки, например $VAR.

Приоритет переменных окружения из списка выше означает. 
что значения переменных окружения заменяются на более приоритетные из списка. 
Например, значение переменной из файла ENVIRONMENT будет заменено на значение из Dockerfile.

Имя будущего приложения формируется из списка по приоритету:
- "unknown" - задается дефолтное значение
- имя каталога проекта, за вычетом лишних символов (если в результате не пустая строка)
- значение переменной $DAM_APP_NAME
- значение флага `--name`

Версия приложения также формируется из списка по приоритету:
- "SNAPSHOT" - дефолтное значение 
- значение переменной $DAM_APP_VERSION
- значение флага `--version`

При создании приложения:
- dam проверяет, указан ли проект. Есть ли в нем Dockerfile и meta/, с файлами install (.exp) и uninstall (.exp)
- формирует список переменных окружения
- проверяет, копируется ли каталог meta в Dockerfile - иначе возникает ошибка. (нет строчек с /meta в ADD или COPY) 
- проверяет, Есть ли метка family в Dockerfile. Если ее нет, то метке присваивается значение такое же, как имя приложения. 
- создается образ приложения с тэгом: <имя дефолтного репозитория>/<имя приложения>:<версия приложения>

Переменные $DAM_APP_NAME, $DAM_APP_VERSION, $DAM_APP_FAMILY, $DAM_APP_MULTIVERSION, $DAM_APP_TAG получаются зарезервированы.

## Зарезервированные переменные

- $DAM_APP_NAME является именем приложения
- $DAM_APP_VERSION версия приложения
- $DAM_APP_FAMILY определяет метку family будущего образа
- $DAM_APP_MULTIVERSION определяет, будет ли возможность установки приложений с меткой family других версий
- $DAM_APP_TAG определяет полный тэг приложения по шаблону `<server>/<app name>:<version>`
- $DAM_APP_SERVERS через запятую, указывает репозитории для тегов, когда приложение устанавливается в системе.
Например, при указании `localhost:5000,` создадутся `localhost:5000/<app name>:<version>` и `<app name>:<version>`
  
## ENVIRONMENT файл
ENVIRONMENT файл проверяется в директории проекта при создании. 
Это сделано, чтобы различные CI/CD перед созданием приложения устанавливали значения переменных окружения для замены в .exp файлах. 

Составлены текущие критерии формата ENVIRONMENT файла:
- Пример строки с установкой значения переменной `FOO=foo`
- Нет проверки строки на пробелы и табуляции в начале
- Комментарии начинаются с символа '#'
- Нельзя присвоить значение для переменной в несколько строчек
- Нельзя использовать комментарии в той же строке, что и переменная
- Строчки не содержащие символ '=' игнорируются

## Dockerfile 
Чтобы извлечь переменные из Dockerfile для замены в .exp файле, необходимо придерживаться:
- Пример `ENV FOO=foo`
- Нет проверки строки на пробелы и табуляции в начале
- Нельзя присвоить значение для переменной в несколько строчек
- Нельзя использовать комментарии в той же строке, что и переменная
- Разделителем имени переменной и значения в строке могут быть символы "=" и " "
- Переменные без значения игнорируются

## Meta
Каталог /meta имеет особенность. Файлы из шаблона .exp в той же директории meta заменяются на файлы без суфикcа .exp.
Также в этих файлах заменяются переменные окружения.

##Registry
Если дефолтный репозиторий в утилите настроен, как официальный, то тэг будет <name>:<version>.

## Testing
В Ubuntu:

Для проверки создается приложение из проекта в каталоге ./src/build/dam-linux/. 
Командой `make linux-app` которая создает установочный образ, созданного под linux приложения.
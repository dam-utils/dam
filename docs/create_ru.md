# v1 сделать dam create
Оставляю эту ветку не завершенной,но она может пригодится в будущем. 
Первая попытку dam create не учитывает нюансы
Решено:
- нет смысла усложнять логику, утилита должна быть простой
- не будет флага указывающего на мету
- Не будет флага указывающего на Dockerfile (тут встает вопрос, как быть с относительными путями в командах)
- будет флаг, указывающий на проект
- Будет валидация, что проект готов для создания приложения (описать в документации)
- следует создать флаг для указания docker build opts
- Указывать метку family
- env файл без изменений


# dam create
Структура каталога проекта:
meta/
- DESCRIPTION (не обязателен)
- install.exp
- uninstall.exp
- ENVIRONMENT (не обязателен)

В этих файлах обязательно должны быть заменены переменные окружения и они превратятся в файлы без .exp
В install должно быть сформировано имя образа, чтобы во внешней системе знать, что устанавливать.
В файлах .exp заменяются все переменные в скобках ${} на переменные из (по приоритету):
- файла ENVIRONMENT
- Dockerfile
- переменных окружения, начинающихся с DAM_PWD="./dam"
Те переменные, что не найдены, выводятся при сборке ворнинги.
И они заменяются на пустое.
(Лучше заменять, а не оставлять их так.
Ведь человек сознательно создает .exp файл.
В нем обычные переменные окружения можно указать просто $VAR)
Можно подумать и реализовать переменные по умолчанию.
При создании ищутся файлы .exp в каталоге meta и заменяются.
Приоритет переменных окружения означает, что при каждой новой проверке, переменные окружения заменяются на более приоритетные из списка приоритетов.
Временная .meta создается в текущем каталоге.

Имя приложения формируется из (по приоритету):
- "unknown"
- имя каталога проекта, за вычетом лишних символов (если не пустое)
- $DAM_APP_NAME

Версия приложения формируется из (по приоритету):
- SNAPSHOT
- $DAM_APP_VERSION

При создании приложения:
- dam проверяет, указан ли Dockerfile, meta/, с файлами install и uninstall 
- формирует список переменных окружения
- создает временный .meta с замененными переменными
- добавляет meta к Dockerfile (или проще в Dockerfile прописывать добавление meta)
- создает образ приложения с тэгом <имя дефолтного репозитория>/<имя приложения>:<версия приложения>
- пишет, что создано приложение <тэг>

Переменные $DAM_APP_NAME и $DAM_APP_VERSION получаются зарезервированы.
Если директория проекта не указана, то это текущая директория.

## ENVIRONMENT файл
Приоритет проверки ENVIRONMENT файла ():
- проверяется в директории проекта
- проверяется указанный во флаге

Можно идти двумя путями для ENVIRONMENT файла:
- взять существующие go проекты, которые берут из файла переменные окружения и загружают их в систему.
Но не правильно смешивать системные переменные и переменные для создания приложения.
Их будет не отделить от системных
- Самому писать загрузку переменных из файла

Решено развивать проект по второму пути.

Составлены критерии формата ENVIRONMENT файла:
- Пример `FOO=foo`
- Не игнорируются пробелы и табуляции
- комментарии с символа '#'
- нельзя переменную в несколько строчек
- нельзя комментарии в той же строке, что и переменная
- строчки без '=' игнорируются

## Dockerfile 
Чтобы извлечь переменные, необходимо придерживаться:
- Пример `ENV FOO=foo`
- Не игнорируются пробелы и табуляции
- нельзя переменную в несколько строчек
- нельзя комментарии в той же строке, что и переменная
- разделителем имени переменной могут быть символы "=" и " "
- переменные без значения игнорируются

При сборке проверяю Dockerfile на наличие копирования meta.
Если мета не копируется (нет строчек с метой ADD или COPY), то генерируется временный `.<md5 [8]>.Dockerfile`
в котором после FROM добавляется строчка `COPY <meta> /meta`

## Meta
Генерирую файлы из шаблона .exp в той же директории meta.

Если есть флаг, с указанием на мету. Значит мета по нестандартному пути. Проверить:
- Если указано в Dockerfile копирование меты - ошибка
- Добавить копирование в dockerfile
Если нет флага:
- Если указано в Dockerfile копирование меты - ок
- Если не указано в Dockerfile копирование меты - указать

# TODO
- Разобраться с созданием файла и флагами
- Dockerfile может называться по другому
- в мапках лучше проверять, что поля ок
- добавить multiversion и family метки и документацию к ним
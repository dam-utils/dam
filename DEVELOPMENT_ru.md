# Текущее состояние проекта
## Changelog
1.x.x
Здесь будут реализованы фичи:
+ dam list - вывод списка установленных приложений
- dam create (ce) - создание приложения на базе образа докера
- dam install (in) - развертывание приложения в системе Linux
- dam remove (rm) - удаление приложения из системы
Планирую закрыть эту ветку до 05-06 2020

2.x.x - добавляются команды:
- dam save - сохранение приложения в архив
- dam install - поправить для установки из файлов-архивов
- dam import - развертывание нескольких приложений с версиями, объединенных в одну группу (продукт)
- dam export - сохранение списка или самих приложений в файл
- dam purge - удаление из локального кэша докера неиспользуемых образов (освобождение места от старых версий приложений) 
Дополнительно:
- dam info - для просмотра информации об установленном приложении
- подсветка текста в поиске и при установке

Так как все доработки не ломают совместимости, планируется ветки, по мере разработки сливать с master и делать соответствующий tag.
Пока не завершится ветка 1.x.x архитектура проекта может меняться

## Нерешенные вопросы, доработки по текущим версиям

- доделать сокращения подкомманд, н.п dam listrepo -> dam lr
- добавить возможность посмотреть версию dam
- возможно стоит переделать сортировку версий приложений для semantic version (плохо отрабатывает на не числовых версиях)
- сделать init тесты для dam search сделав mock для docker api
- продумать поддержку для более широкого числа версий docker api
(возможно стоит делать запрос к server docker, брать версию и сравнивать со своим диапазоном)
- проверить работу с файлами в files_db (возможно неправильное закрытия файла)
- запретить параллельную работу с базой, добавить блокировки (по сути на одной системе, работа команды dam должна быть атомарна)
(возможно стоит проверять, есть ли dam в процессах)
- как хранить login и password. Сейчас логика: 
Если утилита работает с docker под обычным пользователем, она может вычитать секреты из любого места. 
Т.е. имеет смысл защищать секреты от обычных пользователей вне группы docker.
Для этого файлам files_db стоит дать права 600. Вынести настойку прав в конфиг.
- некоторые настройки конфига стоит вынести в переменные окружения (разобраться с viper или сделать dam settings)
- вынести бизнес логику за api из files_db
- часто возникают ошибки - не возможно подключиться к репозиторию. Стоит добавить полезную информацию, почему.
- добавить таймауты на http запросы, Content-Length и обработку кодов возврата.
- рассмотреть работу dam на Windows
- пересмотреть тесты на работу с репозиториями (логика работы с дефолтными репозиториями часто менялась, а тесты на регрессию не добавлялись)
- добавить проверки, в строках DB не должны содержаться символы raw separator и db separator и флаги подкоманд
- пересмотреть систему логирования:
Сейчас на логирование завязаны тесты (это определяет используемый пакет log).
Добавить настройку с выводом дебага.
Добавить log file в котором писались бы установленные/удаленные приложения и ошибки.
Переделать/убрать пакет logger на более удобный.
- dam search возможно, стоит добавить рутины на несколько http запросов (ускорит медленный поиск в официальном репозитории)
- добавить подсветку приложений в поиске, подсветка warn, error и success сообщений.
- в логике работы с репозиториями необходимо определять указан флаг или нет (по дефолтному значению это не определить).
Сейчас определяется как pattern match для os.Args.
И тут могут быть проблемы, если кто-то указал "dam modifyrepo 3 --name=--default ..."  
- добавить описание проекта на английском
- исправить dam help

## При работе с репозиториями
При первом запуске dim видит, что нет в базе записи о репозиториях, создает новую
```
1|*|official|registry.docker.local||
```
Здесь формат `Id|Default|RepoName|RepoServer|Login|Password`.
Эту запись нельзя удалить стандартными средствами dam.

База для хранения репозиториев внутренняя, написана чтобы не было у утилиты внешних зависимостей от дистрибутива. 
Возможно в будущем добавится поддержка Sqlite3, т.к. эта DB идет с большинством дистрибутивов по умолчанию.

### Примечания к репозиториям
- Флаг --default:
  Если добавляется первый репозиторий (автоматически), то он всегда дефолтный. Пишется предупреждение, если флаг дефолта не задается.
  Если добавляется новый репозиторий и указывается дефолтный, то метка со старого снимается.
  Без опции --skip нельзя удалить дефолтный репозиторий.
  При удалении дефолтного репозитория, дефолтным назначается первый.
  Первый репозиторий с id = 0 не удалить, не изменить.  
  По умолчанию, без флага --default, добавляется не дефолтный репозиторий.
  Если дефолтный репозиторий меняется на недефолтный, то дефолтным становится первый репозиторий.
  Если флаг --default не указан при изменении репозитория, то значение Default в базе не меняется.
  Если есть дефолтный репозиторий и новый изменяется на дефолтный, то метка со старого убирается.
  
- Флаг --name:
  При добавлении репозитория, если имя есть в базе, то ошибка.
  Если при добавлении имя - номер (имеет формат, как id), то ошибка.
  Имя репозитория содержит только (3 - 9) буквы и цифры с учетом регистра.
  При изменении на новое имя те же проверки, что и на добавление.
  Если флаг не задан при изменении репозитория, имя не меняется.
  Репозиторий может удаляться, по имени.
  
- Флаг --server:
  Для официального registry - это имя сервера, для локального не только имя, но и префикс приложения до знака "/"
  Это любая не пустая строка до 120 символов.
  
- Флаг --login:
  Любая строка < 24 символов.
  
- Флаг --password:
  Не отображается в выводе.
  Хранится в зашифрованном виде (!) в base64 =).
  
- Id:
  Каждая строка в текстовой базе в начале имеет ID.
  Строки отсортированы по ID в порядке возрастания.
  При удалении репозитория удаляется вся строка с ID и данный номер перестает существовать.
  При добавлении репозитория новый Id берется большим, чем каждый из текущих Id в базе.
  Id с номером 0 - официальный репозиторий.
  
- Флаг --raw:
Выводит информацию об репозиториях

## Термины
- repos - репозиторий приложений DAM ( ~ соответствует префиксу приложения до символа "/")
- app - приложение DAM, специальным образом подготовленный docker image для работы с dam

### dam create
/meta
- DESCRIPTION (не обязателен)
- install.exp
- uninstall.exp
- ENVIRONMENT (не обязателен)

В этих файлах обязательно должны быть заменены переменные окружения и они превратятся в файлы без .exp
В install должно быть сформировано имя образа, чтобы во внешней системе знать, что устанавливать.
В файлах .exp заменяются все переменные в скобках ${} на переменные из (по приоритету):
- файла ENVIRONMENT
- переменных окружения, начинающихся с DAM_PWD="./dam"
- Dockerfile
Те переменные, что не найдены, выводятся при сборке ворнинги.
И они заменяются на пустое.
(Лучше заменять, а не оставлять их так.
Ведь человек сознательно создает .exp файл.
В нем обычные переменные окружения можно указать просто $VAR)
Можно подумать и реализовать переменные по умолчанию.
При создании ищутся файлы .exp в каталоге meta и заменяются.

Имя приложения формируется из (по приоритету):
- "unknown"
- имя каталога проекта, за вычетом лишних символов (если не пустое)
- $DAM_APP_NAME

Версия приложения формируется из (по приоритету):
- SNAPSHOT
- $DAM_APP_VERSION

При создании приложения:
- dam проверяет, указан ли Dockerfile, meta/, с файлами install и uninstall 
- формирует список переменных окружения
- создает временный .meta с замененными переменными
- добавляет meta к Dockerfile (или проще в Dockerfile прописывать добавление meta)
- создает образ приложения с тэгом <имя дефолтного репозитория>/<имя приложения>:<версия приложения>
- пишет, что создано приложение <тэг>

Переменные $DAM_APP_NAME и $DAM_APP_VERSION получаются зарезервированы.
